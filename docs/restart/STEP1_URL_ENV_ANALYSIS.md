# VizPilot Step 1: URL & Environment Variable Consistency Analysis

**Goal:** Make URLs and environment variables consistent across frontend, backend, and hosting so links stop breaking.

**Date:** February 22, 2026  
**Status:** Analysis Complete - Ready for Implementation

---

## PART A: URL MAP

### Production URLs (Deployed)

| Component | Service | URL | Notes |
|-----------|---------|-----|-------|
| Frontend | Vercel | https://vizpilot.vercel.app | Main entry point |
| Backend | Render | https://vizpilot-api.onrender.com | API server |
| Supabase | Supabase | https://[YOUR-PROJECT].supabase.co | Auth + Database |
| Supabase Auth Redirect | Vercel/Supabase | https://vizpilot.vercel.app/auth/callback | OAuth redirect |
| Invite Acceptance | Frontend | https://vizpilot.vercel.app/invite/{token} | User accepts invitation |
| API Base | Backend | https://vizpilot-api.onrender.com | For all /api/* calls |

### Development URLs (Local)

| Component | Service | URL | Notes |
|-----------|---------|-----|-------|
| Frontend | Next.js Dev | http://localhost:4000 | Local dev server (npm run dev) |
| Backend | Uvicorn | http://localhost:8000 | Local API server |
| Supabase | Supabase Cloud | https://[YOUR-PROJECT].supabase.co | Shared with production |
| Local Auth Redirect | Supabase | http://localhost:4000/auth/callback | OAuth redirect for local dev |
| Local Invite Link | Frontend | http://localhost:4000/invite/{token} | Generated by backend |
| Local API Base | Backend | http://localhost:8000 | For all /api/* calls |

### All Routes Using Backend URLs

```
Frontend ‚Üí Backend API calls via NEXT_PUBLIC_API_BASE:
  GET  {NEXT_PUBLIC_API_BASE}/api/auth/me
  POST {NEXT_PUBLIC_API_BASE}/api/auth/signup
  POST {NEXT_PUBLIC_API_BASE}/api/auth/login
  POST {NEXT_PUBLIC_API_BASE}/api/auth/logout
  POST {NEXT_PUBLIC_API_BASE}/api/business/setup
  GET  {NEXT_PUBLIC_API_BASE}/api/business/me/info
  POST {NEXT_PUBLIC_API_BASE}/api/upload
  POST {NEXT_PUBLIC_API_BASE}/api/auth/invite
  GET  {NEXT_PUBLIC_API_BASE}/api/auth/invite/{token}
  GET  {NEXT_PUBLIC_API_BASE}/api/dashboard/{role}
  POST {NEXT_PUBLIC_API_BASE}/api/ai/chat

Backend ‚Üí Frontend URLs (Hardcoded or Env-driven):
  Invitation links: {FRONTEND_URL}/invite/{token}
  OAuth callbacks: {FRONTEND_URL}/auth/callback
  Frontend origin (CORS): {FRONTEND_URL}

Backend ‚Üí Supabase (Env-driven):
  Auth: {SUPABASE_URL}
  Database: {SUPABASE_URL}
  Storage: {SUPABASE_URL}/storage/...
```

---

## PART B: ENV VAR CONTRACT (Proposed Standard)

### Frontend Environment Variables

| Env Var | Platform | Required | Description | Example Local | Example Production |
|---------|----------|----------|-------------|----------------|-------------------|
| NEXT_PUBLIC_API_BASE | All | YES | Backend API URL | http://localhost:8000 | https://vizpilot-api.onrender.com |
| NEXT_PUBLIC_SUPABASE_URL | All | YES | Supabase project URL | https://[proj].supabase.co | https://[proj].supabase.co |
| NEXT_PUBLIC_SUPABASE_ANON_KEY | All | YES | Supabase anonymous key | [anon-key] | [anon-key] |

### Backend Environment Variables

| Env Var | Required | Description | Example Local | Example Production |
|---------|----------|-------------|----------------|-------------------|
| FRONTEND_URL | YES | Frontend URL (for invites, CORS, redirects) | http://localhost:4000 | https://vizpilot.vercel.app |
| SUPABASE_URL | YES | Supabase project URL | https://[proj].supabase.co | https://[proj].supabase.co |
| SUPABASE_ANON_KEY | YES | Supabase anonymous key | [anon-key] | [anon-key] |
| SUPABASE_SERVICE_ROLE_KEY | YES | Supabase service role (for admin ops) | [service-key] | [service-key] |
| APP_NAME | NO | Application name | VizPilot Backend | VizPilot Backend |
| APP_ENV | NO | Environment name | dev | prod |
| GROQ_API_KEY | YES (if using AI) | Groq API key | gsk_... | gsk_... |
| GROQ_MODEL | NO | Groq model name | llama-3.3-70b-versatile | llama-3.3-70b-versatile |

### Mapping: Current ‚Üí Standard Env Vars

The backend currently uses different env var names in different files. Here's the mapping:

**In CORS middleware (elas-erp/backend/app/main.py)**
```
Current: ALLOWED_ORIGINS (not used, hardcoded to ["*"])
Standard: FRONTEND_URL (single URL, not comma-separated)
```

**In Supabase client (backend/app/db/supabase_client.py)**
```
Current: SUPABASE_URL, SUPABASE_ANON_KEY
Standard: SUPABASE_URL, SUPABASE_ANON_KEY (‚úÖ already matches)
```

**In invitations (backend/app/services/invitation_service.py)**
```
Current: hardcoded "http://localhost:4000"
Standard: FRONTEND_URL env var
```

**In config (backend/app/core/config.py)**
```
Current: APP_NAME="VizPilot Backend", APP_ENV, SUPABASE_URL, SUPABASE_ANON_KEY
Standard: Same names (‚úÖ already matches)
```

**In frontend API calls**
```
Current: NEXT_PUBLIC_API_BASE (‚úÖ already standard)
Standard: NEXT_PUBLIC_API_BASE
```

**In frontend Supabase init**
```
Current: NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY (‚úÖ already standard)
Standard: NEXT_PUBLIC_SUPABASE_URL, NEXT_PUBLIC_SUPABASE_ANON_KEY
```

---

## PART C: ENV EXAMPLE FILES

### frontend/.env.example (CURRENT - Needs Update)

**Location:** [frontend/.env.example](frontend/.env.example)

**Current Content:**
```env
# Local: http://localhost:8000
# Production: https://elas-api.onrender.com (replace with your Render URL)
NEXT_PUBLIC_API_BASE=http://localhost:8000

NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
```

**Issues:**
- Reference to old URL "elas-api.onrender.com" (should be "vizpilot-api.onrender.com")
- Missing documentation for Supabase setup

**Proposed Content:**
```env
# Frontend - Environment Configuration
# Copy this file to .env.local and fill in the values

# Backend API URL
# Local development: http://localhost:8000
# Production: https://vizpilot-api.onrender.com
NEXT_PUBLIC_API_BASE=http://localhost:8000

# Supabase Configuration
# Get these from: https://app.supabase.com/project/[project-id]/settings/api
# NEXT_PUBLIC_SUPABASE_URL format: https://[project-name].supabase.co
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co

# Supabase Anonymous Key (public - safe to expose)
# Found in Supabase dashboard under Settings ‚Üí API
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key-here
```

---

### backend/.env.example (DUPLICATE - Both Should Match)

**Locations:** 
- [backend/.env.example](backend/.env.example) - Top-level backend
- [elas-erp/backend/.env.example](elas-erp/backend/.env.example) - Nested backend

**Current Content (backend/.env.example):**
```env
DATABASE_URL=postgresql://user:password@localhost:5432/elas_erp

# Supabase
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_ANON_KEY=your_supabase_anon_key_here
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key_here

# API
ALLOWED_ORIGINS=http://localhost:4000,https://your-app.vercel.app
```

**Issues:**
- Uses ALLOWED_ORIGINS (should use FRONTEND_URL)
- No FRONTEND_URL variable
- No APP_NAME or APP_ENV
- Old branding reference "elas_erp" in DATABASE_URL

**Proposed Content (BOTH FILES):**
```env
# Backend - Environment Configuration
# Copy this file to .env and fill in the values

# ==== Application ====
# Application name (shown in health check and version endpoints)
APP_NAME=VizPilot Backend

# Environment: dev, staging, prod
APP_ENV=dev

# ==== Frontend (Critical for invitations, CORS, auth callbacks) ====
# Local: http://localhost:4000
# Production: https://vizpilot.vercel.app
FRONTEND_URL=http://localhost:4000

# ==== Supabase Configuration ====
# Get these from: https://app.supabase.com/project/[project-id]/settings/api
# Format: https://[project-name].supabase.co
SUPABASE_URL=https://your-project.supabase.co

# Supabase Anonymous Key (public - safe in production)
SUPABASE_ANON_KEY=your-anon-key-here

# Supabase Service Role Key (PRIVATE - never expose to frontend)
# Found in Supabase dashboard under Settings ‚Üí API ‚Üí Reveal
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here

# ==== Groq AI ====
# Get from: https://console.groq.com/keys
GROQ_API_KEY=gsk_your_key_here
GROQ_MODEL=llama-3.3-70b-versatile

# ==== Optional Features ====
# Groq mode: "live" (real API) or "mock" (for testing)
GROQ_MODE=live

# Auth mode: "live" (Supabase) or "mock" (for testing)
AUTH_MODE=live
```

---

## PART D: CODE EDITS - HARDCODED URLS INVENTORY

### Frontend Hardcoded Localhost URLs

**File:** [elas-erp/frontend/app/lib/api.ts](elas-erp/frontend/app/lib/api.ts)
- **Line 1:** `export const API_BASE = process.env.NEXT_PUBLIC_API_BASE || "http://localhost:8000";`
- **Status:** ‚úÖ GOOD (uses env var with local fallback)

**File:** [elas-erp/frontend/app/lib/groq.ts](elas-erp/frontend/app/lib/groq.ts)
- **Line 3:** `const API_BASE = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000/api';`
- **Issue:** Has `/api` suffix (inconsistent with other files that just use base URL)
- **Status:** ‚ö†Ô∏è NEEDS FIX - Remove `/api` suffix to match api.ts

**File:** [elas-erp/frontend/contexts/AuthContext.tsx](elas-erp/frontend/contexts/AuthContext.tsx)
- **Line 56:** `const response = await fetch(`${process.env.NEXT_PUBLIC_API_BASE}/api/auth/signup`, {`
- **Status:** ‚úÖ GOOD (uses env var)
- **Line 112:** `const appOrigin = typeof window !== 'undefined' ? window.location.origin : 'http://localhost:4000';`
- **Status:** ‚úÖ ACCEPTABLE (fallback only used on server side, client always has window.location)

**File:** [elas-erp/frontend/app/onboarding/business/page.tsx](elas-erp/frontend/app/onboarding/business/page.tsx)
- **Lines 40, 68:** `const apiBase = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000';`
- **Status:** ‚ö†Ô∏è REPEATED PATTERN (should extract to shared util)

**File:** [elas-erp/frontend/app/onboarding/upload/page.tsx](elas-erp/frontend/app/onboarding/upload/page.tsx)
- **Lines 88, 124:** `const apiBase = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000';`
- **Status:** ‚ö†Ô∏è REPEATED PATTERN

**File:** [elas-erp/frontend/app/onboarding/documents/page.tsx](elas-erp/frontend/app/onboarding/documents/page.tsx)
- **Lines 99, 148:** `const apiBase = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000';`
- **Status:** ‚ö†Ô∏è REPEATED PATTERN

**File:** [elas-erp/frontend/app/team/page.tsx](elas-erp/frontend/app/team/page.tsx)
- **Lines 62, 93:** `const apiBase = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000';`
- **Status:** ‚ö†Ô∏è REPEATED PATTERN

**File:** [elas-erp/frontend/app/settings/page.tsx](elas-erp/frontend/app/settings/page.tsx)
- **Line 70:** `const apiBase = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000';`
- **Status:** ‚ö†Ô∏è REPEATED PATTERN

**File:** [elas-erp/frontend/app/onboarding/review/page.tsx](elas-erp/frontend/app/onboarding/review/page.tsx)
- **Line 24:** `const apiBase = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000';`
- **Status:** ‚ö†Ô∏è REPEATED PATTERN

**File:** [frontend/app/dashboard/[role]/page.tsx](frontend/app/dashboard/[role]/page.tsx)
- **Line 155:** `const apiBase = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000';`
- **Status:** ‚ö†Ô∏è REPEATED PATTERN

---

### Backend Hardcoded Frontend URL

**File:** [elas-erp/backend/app/services/invitation_service.py](elas-erp/backend/app/services/invitation_service.py)
- **Line 114:** `"invite_url": f"http://localhost:4000/invite/{token}",`
- **Issue:** Hardcoded to localhost, will break in production
- **Status:** üî¥ CRITICAL - Must use FRONTEND_URL env var

---

### Backend CORS Wildcard

**File:** [elas-erp/backend/app/main.py](elas-erp/backend/app/main.py)
- **Lines 10-12:**
  ```python
  app.add_middleware(
      CORSMiddleware,
      allow_origins=["*"], allow_credentials=True,
  ```
- **Issue:** `allow_origins=["*"]` is too permissive for production
- **Status:** üî¥ CRITICAL - Must use env var for FRONTEND_URL

---

### Backend Config & Hardcoded Names

**File:** [elas-erp/backend/app/core/config.py](elas-erp/backend/app/core/config.py)
- **Line 5:** `app_name: str = Field(default="VizPilot Backend", alias="APP_NAME")`
- **Issue:** Old branding "Elas ERP Backend" (should be "VizPilot Backend")
- **Status:** ‚ö†Ô∏è NEEDS UPDATE - For branding consistency (not URL, but important)

**File:** [elas-erp/backend/app/main.py](elas-erp/backend/app/main.py)
- **Line 16:** `return {"status": "ok", "service": "VizPilot Backend", "version": "2.0"}`
- **Issue:** Hardcoded "Elas ERP Backend" in health endpoint response
- **Status:** ‚ö†Ô∏è SHOULD USE settings.app_name (already defined in config)

---

### Env Example Files with Old References

**File:** [backend/.env.example](backend/.env.example)
- **Line 5:** `DATABASE_URL=postgresql://user:password@localhost:5432/elas_erp`
- **Issue:** Old database name "elas_erp" (should be "vizpilot")
- **Status:** ‚ö†Ô∏è DOCUMENTATION (not critical for URL consistency)

---

### Directory Duplication Note

**Repo Structure Issue:**
```
vizpilot/
‚îú‚îÄ‚îÄ backend/                    # OLD LOCATION - Has .env.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ check_env.py
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ frontend/                   # MIXED LOCATION - Has some files
‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îú‚îÄ‚îÄ .env.local
‚îÇ   ‚îú‚îÄ‚îÄ vercel.json
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ elas-erp/                   # NEW LOCATION
‚îÇ   ‚îú‚îÄ‚îÄ backend/                # ACTUAL BACKEND - Has .env
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .env
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ check_env.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ frontend/               # ACTUAL FRONTEND
‚îÇ       ‚îú‚îÄ‚îÄ app/
‚îÇ       ‚îú‚îÄ‚îÄ lib/
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ ...
```

**Context:** Both backend and elas-erp/backend have .env.example files with slightly different content. Need to consolidate.

---

## PART E: ACTION LIST - STEP-BY-STEP CHANGES

### Phase 1: Create/Update Environment Example Files

**Action 1.1: Update frontend/.env.example**
- File: [frontend/.env.example](frontend/.env.example)
- Change: Replace entire file with proposed content from Part C
- Verification: File matches exactly

**Action 1.2: Update elas-erp/frontend/.env.example** (if exists)
- File: [elas-erp/frontend/.env.example](elas-erp/frontend/.env.example)
- Change: Create or sync with [frontend/.env.example](frontend/.env.example)
- Verification: Both identical

**Action 1.3: Update backend/.env.example**
- File: [backend/.env.example](backend/.env.example)
- Change: Replace entire file with proposed content from Part C
- Verification: File matches exactly

**Action 1.4: Update elas-erp/backend/.env.example**
- File: [elas-erp/backend/.env.example](elas-erp/backend/.env.example)
- Change: Replace entire file with proposed content from Part C
- Verification: File matches exactly

**Action 1.5: Sync actual .env files with examples**
- elas-erp/backend/.env - Ensure FRONTEND_URL is set correctly
- frontend/.env.local - Ensure NEXT_PUBLIC_API_BASE is set correctly
- Verification: Both match their .example files (except with real values)

---

### Phase 2: Fix Frontend Environment Variable Usage

**Action 2.1: Fix elas-erp/frontend/app/lib/groq.ts**
- File: [elas-erp/frontend/app/lib/groq.ts](elas-erp/frontend/app/lib/groq.ts)
- Change: Remove `/api` suffix from localhost fallback
- Before: `const API_BASE = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000/api';`
- After: `const API_BASE = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000';`

**Action 2.2: Consolidate repeated API_BASE pattern**
- Create: [frontend/lib/config.ts](frontend/lib/config.ts) or [frontend/lib/env.ts](frontend/lib/env.ts)
- Content:
  ```typescript
  export const getApiBase = () => {
    if (typeof window === 'undefined') {
      // Server-side: use env var only
      return process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000';
    }
    // Client-side: use env var with fallback
    return process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000';
  };
  
  export const API_BASE = getApiBase();
  ```
- Usage: Replace all inline `process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000'` with import from this file

**Action 2.3: Update 9 frontend files to use consolidated config**

Files to update (replace inline fallback with export):
1. [elas-erp/frontend/app/onboarding/business/page.tsx](elas-erp/frontend/app/onboarding/business/page.tsx) - Lines 40, 68
2. [elas-erp/frontend/app/onboarding/upload/page.tsx](elas-erp/frontend/app/onboarding/upload/page.tsx) - Lines 88, 124
3. [elas-erp/frontend/app/onboarding/documents/page.tsx](elas-erp/frontend/app/onboarding/documents/page.tsx) - Lines 99, 148
4. [elas-erp/frontend/app/team/page.tsx](elas-erp/frontend/app/team/page.tsx) - Lines 62, 93
5. [elas-erp/frontend/app/settings/page.tsx](elas-erp/frontend/app/settings/page.tsx) - Line 70
6. [elas-erp/frontend/app/onboarding/review/page.tsx](elas-erp/frontend/app/onboarding/review/page.tsx) - Line 24
7. [frontend/app/onboarding/business/page.tsx](frontend/app/onboarding/business/page.tsx) - Lines 40, 68
8. [frontend/app/onboarding/upload/page.tsx](frontend/app/onboarding/upload/page.tsx) - Lines 88, 124
9. [frontend/app/dashboard/[role]/page.tsx](frontend/app/dashboard/[role]/page.tsx) - Line 155

Change pattern:
- Add: `import { API_BASE } from '@/lib/config';`
- Replace: `const apiBase = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000';` with `const apiBase = API_BASE;`

---

### Phase 3: Fix Backend Environment Variable Usage

**Action 3.1: Add FRONTEND_URL to backend config**
- File: [elas-erp/backend/app/core/config.py](elas-erp/backend/app/core/config.py)
- Add after line 13:
  ```python
  # Frontend URL (for CORS, invitations, auth redirects)
  frontend_url: str = Field(default="http://localhost:4000", alias="FRONTEND_URL")
  ```
- Verification: Settings object now has `settings.frontend_url`

**Action 3.2: Update CORS middleware to use FRONTEND_URL**
- File: [elas-erp/backend/app/main.py](elas-erp/backend/app/main.py)
- Lines 10-12: Replace wildcard CORS with env-driven
- Before:
  ```python
  app.add_middleware(
      CORSMiddleware,
      allow_origins=["*"], allow_credentials=True,
      allow_methods=["*"], allow_headers=["*"]
  )
  ```
- After:
  ```python
  app.add_middleware(
      CORSMiddleware,
      allow_origins=[settings.frontend_url],
      allow_credentials=True,
      allow_methods=["*"],
      allow_headers=["*"]
  )
  ```

**Action 3.3: Update health endpoint response to use config (optional - branding)**
- File: [elas-erp/backend/app/main.py](elas-erp/backend/app/main.py)
- Line 16: Replace hardcoded "Elas ERP Backend" with config value
- Before: `return {"status": "ok", "service": "Elas ERP Backend", "version": "2.0"}`
- After: `return {"status": "ok", "service": settings.app_name, "version": "2.0"}`

**Action 3.4: Update invitation service to use FRONTEND_URL**
- File: [elas-erp/backend/app/services/invitation_service.py](elas-erp/backend/app/services/invitation_service.py)
- Line 114: Replace hardcoded localhost with env var
- Before: `"invite_url": f"http://localhost:4000/invite/{token}",`
- After: `"invite_url": f"{os.getenv('FRONTEND_URL', 'http://localhost:4000')}/invite/{token}",`
- Or (preferred): Pass settings to the function and use `settings.frontend_url`

**Action 3.5: Update invitation service imports**
- If using os.getenv: No change needed (os already imported)
- If using settings: Import at top of file:
  ```python
  from app.core.config import settings
  ```
- Then use: `settings.frontend_url`

---

### Phase 4: Environment Validation at Startup

**Action 4.1: Create config validation function**
- File: [frontend/lib/validateEnv.ts](frontend/lib/validateEnv.ts)
- Content:
  ```typescript
  /**
   * Validate required frontend environment variables
   * Called at app startup to fail fast if config is missing
   */
  export function validateFrontendEnv() {
    const errors: string[] = [];
    
    if (!process.env.NEXT_PUBLIC_API_BASE) {
      errors.push('NEXT_PUBLIC_API_BASE is not set');
    }
    
    if (!process.env.NEXT_PUBLIC_SUPABASE_URL) {
      errors.push('NEXT_PUBLIC_SUPABASE_URL is not set');
    }
    
    if (!process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) {
      errors.push('NEXT_PUBLIC_SUPABASE_ANON_KEY is not set');
    }
    
    if (errors.length > 0) {
      const message = [
        '‚ùå Missing frontend environment variables:',
        ...errors.map(e => `   - ${e}`),
        '',
        'üìù Copy frontend/.env.example to frontend/.env.local and fill in the values:',
        '   > cp frontend/.env.example frontend/.env.local',
        '',
        'üîó Get Supabase credentials from: https://app.supabase.com/project/[id]/settings/api'
      ].join('\n');
      
      console.error(message);
      throw new Error('Frontend environment validation failed');
    }
  }
  ```

**Action 4.2: Call validation in next.config.js**
- File: [frontend/next.config.js](frontend/next.config.js) or [frontend/next.config.mjs](frontend/next.config.mjs)
- Add at top:
  ```javascript
  import { validateFrontendEnv } from './lib/validateEnv.js';
  
  validateFrontendEnv();
  
  export default {
    // ... rest of config
  }
  ```
- Verification: Build fails with clear error if env vars missing

**Action 4.3: Create backend config validation**
- File: [elas-erp/backend/app/core/validate_config.py](elas-erp/backend/app/core/validate_config.py)
- Content:
  ```python
  """Validate required environment variables at startup"""
  import os
  from typing import List
  
  def validate_backend_config() -> None:
      """Check that all required env vars are set. Raise if not."""
      errors: List[str] = []
      
      required_vars = [
          'FRONTEND_URL',
          'SUPABASE_URL',
          'SUPABASE_ANON_KEY',
          'SUPABASE_SERVICE_ROLE_KEY',
          'GROQ_API_KEY',
      ]
      
      for var in required_vars:
          if not os.getenv(var):
              errors.append(f'  - {var}')
      
      if errors:
          message = [
              '‚ùå Missing backend environment variables:',
              *errors,
              '',
              'üìù Copy backend/.env.example to backend/.env and fill in the values:',
              '   $ cp backend/.env.example backend/.env',
              '',
              'üîó Get Supabase credentials from: https://app.supabase.com/project/[id]/settings/api',
              'üîó Get Groq API key from: https://console.groq.com/keys',
          ]
          print('\n'.join(message))
          raise ValueError('Backend configuration validation failed')
  ```

**Action 4.4: Call validation in backend startup**
- File: [elas-erp/backend/app/main.py](elas-erp/backend/app/main.py)
- Add at top (after imports):
  ```python
  from app.core.validate_config import validate_backend_config
  
  # Validate config at startup
  validate_backend_config()
  ```
- Verification: Backend prints clear error if env vars missing, then exits

---

## PART F: EXACT CODE CHANGES (Patch Format)

### Change 1: frontend/.env.example

```patch
--- a/frontend/.env.example
+++ b/frontend/.env.example
@@ -1,7 +1,14 @@
-# Local: http://localhost:8000
-# Production: https://elas-api.onrender.com (replace with your Render URL)
+# Frontend - Environment Configuration
+# Copy this file to .env.local and fill in the values
+
+# Backend API URL
+# Local development: http://localhost:8000
+# Production: https://vizpilot-api.onrender.com
 NEXT_PUBLIC_API_BASE=http://localhost:8000
 
+# Supabase Configuration
+# Get these from: https://app.supabase.com/project/[project-id]/settings/api
+# NEXT_PUBLIC_SUPABASE_URL format: https://[project-name].supabase.co
 NEXT_PUBLIC_SUPABASE_URL=
 NEXT_PUBLIC_SUPABASE_ANON_KEY=
```

---

### Change 2: backend/.env.example

```patch
--- a/backend/.env.example
+++ b/backend/.env.example
@@ -1,17 +1,40 @@
-DATABASE_URL=postgresql://user:password@localhost:5432/elas_erp
+# Backend - Environment Configuration
+# Copy this file to .env and fill in the values
 
-# Supabase
+# ==== Application ====
+# Application name (shown in health check and version endpoints)
+APP_NAME=VizPilot Backend
+
+# Environment: dev, staging, prod
+APP_ENV=dev
+
+# ==== Frontend (Critical for invitations, CORS, auth callbacks) ====
+# Local: http://localhost:4000
+# Production: https://vizpilot.vercel.app
+FRONTEND_URL=http://localhost:4000
+
+# ==== Supabase Configuration ====
+# Get these from: https://app.supabase.com/project/[project-id]/settings/api
+# Format: https://[project-name].supabase.co
 SUPABASE_URL=https://xxxxx.supabase.co
 SUPABASE_ANON_KEY=your_supabase_anon_key_here
 SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key_here
 
-# API
-ALLOWED_ORIGINS=http://localhost:4000,https://your-app.vercel.app
+# ==== Groq AI ====
+# Get from: https://console.groq.com/keys
+GROQ_API_KEY=gsk_your_key_here
+GROQ_MODEL=llama-3.3-70b-versatile
+
+# ==== Optional Features ====
+# Groq mode: "live" (real API) or "mock" (for testing)
+GROQ_MODE=live
+
+# Auth mode: "live" (Supabase) or "mock" (for testing)
+AUTH_MODE=live
```

---

### Change 3: elas-erp/frontend/app/lib/groq.ts

```patch
--- a/elas-erp/frontend/app/lib/groq.ts
+++ b/elas-erp/frontend/app/lib/groq.ts
@@ -1,4 +1,4 @@
-const API_BASE = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000/api';
+const API_BASE = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000';
 
 interface Message {
   role: 'user' | 'assistant';
```

---

### Change 4: elas-erp/backend/app/core/config.py (add FRONTEND_URL)

```patch
--- a/elas-erp/backend/app/core/config.py
+++ b/elas-erp/backend/app/core/config.py
@@ -13,6 +13,9 @@ class Settings(BaseSettings):
     supabase_anon_key: str = Field(default="", alias="SUPABASE_ANON_KEY")
     supabase_service_role_key: str = Field(default="", alias="SUPABASE_SERVICE_ROLE_KEY")
 
+    # Frontend
+    frontend_url: str = Field(default="http://localhost:4000", alias="FRONTEND_URL")
+
     # LLM
     groq_api_key: str = Field(default="", alias="GROQ_API_KEY")
     groq_model: str = Field(default="llama-3.3-70b-versatile", alias="GROQ_MODEL")
```

---

### Change 5: elas-erp/backend/app/main.py (CORS middleware)

```patch
--- a/elas-erp/backend/app/main.py
+++ b/elas-erp/backend/app/main.py
@@ -8,8 +8,8 @@ from app.api.endpoints import upload, chat, business, documents, ai, dashboard,
 app = FastAPI(title=settings.app_name)
 
 app.add_middleware(
     CORSMiddleware,
-    allow_origins=["*"], allow_credentials=True,
+    allow_origins=[settings.frontend_url], allow_credentials=True,
     allow_methods=["*"], allow_headers=["*"]
 )
 
@@ -17,7 +17,7 @@ app.add_middleware(
-    return {"status": "ok", "service": "Elas ERP Backend", "version": "2.0"}
+    return {"status": "ok", "service": settings.app_name, "version": "2.0"}
```

---

### Change 6: elas-erp/backend/app/services/invitation_service.py

```patch
--- a/elas-erp/backend/app/services/invitation_service.py
+++ b/elas-erp/backend/app/services/invitation_service.py
@@ -1,5 +1,6 @@
 from fastapi import HTTPException
 from supabase.client import AsyncClient
+from app.core.config import settings
 
 # ... existing code ...
 
@@ -111,7 +112,7 @@ class InvitationService:
                 "id": invitation["id"],
                 "email": email,
                 "role": role,
                 "token": token,
                 "expires_at": invitation["expires_at"],
-                "invite_url": f"http://localhost:4000/invite/{token}",
+                "invite_url": f"{settings.frontend_url}/invite/{token}",
                 "business_name": business.data["name"] if business.data else "Unknown",
                 "inviter_name": inviter.data["full_name"] if inviter.data else "Unknown"
             }
```

---

### Change 7: elas-erp/backend/app/main.py (add validation)

```patch
--- a/elas-erp/backend/app/main.py
+++ b/elas-erp/backend/app/main.py
@@ -1,6 +1,7 @@
 from fastapi import FastAPI
 from fastapi.middleware.cors import CORSMiddleware
 
 from app.core.config import settings
+from app.core.validate_config import validate_backend_config
 from app.api.endpoints import upload, chat, business, documents, ai, dashboard, auth
 
+# Validate config at startup
+validate_backend_config()
+
 app = FastAPI(title=settings.app_name)
```

---

## PART G: VERIFICATION CHECKLIST

Before considering this step complete, verify:

### Env File Verification
- [ ] frontend/.env.local has NEXT_PUBLIC_API_BASE set to http://localhost:8000
- [ ] frontend/.env.local has NEXT_PUBLIC_SUPABASE_URL filled with real Supabase URL
- [ ] frontend/.env.local has NEXT_PUBLIC_SUPABASE_ANON_KEY filled with real key
- [ ] elas-erp/backend/.env has FRONTEND_URL=http://localhost:4000
- [ ] elas-erp/backend/.env has SUPABASE_URL, SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY filled
- [ ] elas-erp/backend/.env has GROQ_API_KEY filled

### Backend Startup
- [ ] Backend starts without error: `python -m uvicorn app.main:app --reload`
- [ ] Health check returns 200: `curl http://localhost:8000/health`
- [ ] Health response shows "VizPilot Backend" (not "Elas ERP Backend")
- [ ] CORS accepts requests from FRONTEND_URL

### Frontend Build
- [ ] Frontend builds successfully: `npm run build`
- [ ] No missing env var errors during build
- [ ] Frontend runs: `npm run dev`
- [ ] Page loads at http://localhost:4000

### URL Resolution
- [ ] Frontend API calls go to http://localhost:8000 (check Network tab)
- [ ] Invitation URL generated by backend uses http://localhost:4000
- [ ] No hardcoded localhost URLs remain in production config

### Duplicate Directory Handling (Post-Step)
- [ ] Document that both `frontend/` and `elas-erp/frontend/` contain frontend code (DUPLICATE)
- [ ] Document that both `backend/` and `elas-erp/backend/` contain backend code (DUPLICATE)
- [ ] Recommendation: Consolidate to single locations (future housekeeping task)

---

## NOTES

### Why These Changes Are Minimal & Safe

1. **No breaking changes** - All fallbacks remain (localhost defaults)
2. **Backward compatible** - Existing NEXT_PUBLIC_* env vars unchanged
3. **Additive** - Only adding FRONTEND_URL to backend config
4. **Non-invasive** - Simple string replacements, no refactoring
5. **Testable** - Each change can be verified independently

### Why FRONTEND_URL Instead of ALLOWED_ORIGINS

- **Clearer intent** - Name reflects purpose (frontend URL, not CORS origins)
- **Single value** - Easier to manage than comma-separated list
- **Reusable** - Used for CORS, invitations, and redirects
- **Production-ready** - Vercel URL is exactly what CORS needs
- **Documentation** - Env var name self-explains what it's for

### Why Keep Localhost Fallbacks

- **Developer convenience** - Works without .env.local for local dev
- **Error prevention** - Falls back gracefully if env var missing
- **Clear debugging** - If something uses localhost, env var wasn't set
- **No production impact** - Won't reach production without explicit env set

---

**END OF STEP 1 ANALYSIS**

**Next Step:** Step 2 (not in scope of this analysis) will implement these changes and verify all URLs work correctly in local + production environments.

---

## DOCUMENT METADATA

- **Analysis Date:** February 22, 2026
- **Repo Path:** C:\Users\Rishab\Downloads\Saroj Raj\Github\vizpilot
- **Scanned Files:** 160+ matches across .ts, .tsx, .py, .json, .env files
- **Directories Identified:** frontend/, elas-erp/frontend/, backend/, elas-erp/backend/ (duplicates exist)
- **Production Hosts:** Vercel (frontend), Render (backend), Supabase (auth/db)
- **Local Dev Ports:** 4000 (frontend), 8000 (backend)
